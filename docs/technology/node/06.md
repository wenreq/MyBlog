---
title: express
lang: zh-CN
---

## 目标

- 使用 `express.static()` 快速托管静态资源
- 使用 express **路由**精简项目结构
- 使用常见的 express **中间件**
- 使用 express 创建 API **接口**
- 在 express 中启用 `cors` 跨域资源共享

## 目录

- 初识 Express
- Express 路由
- Express 中间件
- 使用 Express 写接口

## 1. 初识 Express

### 1.1 简介

官方：Express 是基于 Node.js 平台，快速、开放、极简的 Web 开发框架。

通俗理解：Express 的作用和 Node.js 内置的 http 模块类似，是专门用来创建 Web 服务器的。

本质：就是一个 npm 上的第三方包，提供快速创建 Web 服务器的便捷方法。

### 1.2 基本用法

1. 安装：`npm i express@4.17.1`

2. 创建基本的 Web 服务器

```js
// 1. 导入 express
const express = require("express");
// 2. 创建 web 服务器
const app = express();

// 3. 调用 app.listen (端口号，启动成功后的回调函数)，启动服务器
app.listen(80, () => {
  console.log("express server running at http://127.0.0.1");
});
```

#### 监听 GET、POST 请求

通过 `app.get()` 方法，可以监听客户端的 GET 请求。

```js
// req: 请求对象
// res: 响应对象
app.get("请求URL", function (req, res) {
  /* 处理函数 */
});
```

通过 `app.post()` 方法，可以监听客户端的 POST 请求。

```js
// req: 请求对象
// res: 响应对象
app.post("请求URL", function (req, res) {
  /* 处理函数 */
});
```

#### 把内容响应给客户端

通过 `res.send()` 方法，可以把处理好的内容，发送给客户端：

```js
app.get("/user", (req, res) => {
  // 向客户端发送 JSON 对象
  res.send({ name: "zs", age: 28, gender: "男" });
});

app.post("/user", (req, res) => {
  // 向客户端发送文本内容
  res.send("请求成功");
});
```

#### 获取 URL 中携带的查询参数

通过 `req.query` 对象，可以访问到客户端通过查询字符串的形式，发送到服务的参数。

#### 获取 URL 中的动态参数

通过 `req.params` 对象，可以访问到 URL 中，通过 `:` 匹配到的动态参数。

### 1.3 托管静态资源

#### express.static

express 提供了一个非常好用的函数，叫 `express.static()`，通过它，我们可以非常方便地创建一个静态资源服务器，例如，通过如下代码可以将 public 目录下的图片、CSS 文件、JavaScript 文件对外开发访问了：

```js
app.use(express.static("public"));
```

可以访问 public 目录中的所有文件了：

- `http://localhost:3000/images/bg.jpg`
- `http://localhost:3000/css/style.css`
- `http://localhost:3000/js/login.js`

注意：Express 在指定的静态目录中查找文件，并对外提供资源的访问路径。因此，**存放静态文件的目录名不会出现在 URL 中**。

#### 托管多个静态资源目录

多次调用 `express.static()` 函数：

```js
app.use(express.static("public"));
app.use(express.static("files"));
```

访问静态资源文件时，`express.static()` 函数会根据目录的**添加顺序**查找所需的文件。

#### 挂载路径前缀

如果希望在托管的静态资源访问路径之前，挂载路径前缀，则可以使用如下的方式：

```js
app.use("/public", express.static("public"));
```

- `http://localhost:3000/public/images/bg.jpg`
- `http://localhost:3000/public/css/style.css`
- `http://localhost:3000/public/js/login.js`

### 1.4 nodemon

它能监听项目文件的变动，当代码被修改后，nodemon 会自动帮我们重启项目。

安装：`npm install -g nodemon`

使用：`nodemon app.js` 来启动项目，代码被修改之后，会被 nodemon 监听到，从而实现自动重启项目的效果。

## 2. Express 路由

路由就是**映射**关系。

在 Express 中，路由指的是**客户端的请求**和**服务器处理函数**之间的映射关系。

Express 中的路由分 3 部分组成，分别是请求的**类型**、**请求的 URL 地址**、**处理函数**。

```js
app.METHOD(PATH, HANDLER);
```

**路由的匹配**过程：每当一个请求到达服务器之后，需要先经过路由的匹配，只有匹配成功之后，才会调用对应的处理函数。

在匹配时，会按照路由的顺序进行匹配，如果请求类型和请求的 URL 同时匹配成功，则 Express 会将这个请求，转交给对应的 function 函数进行处理。

匹配注意点：1. 按照定义的**先后顺序**进行匹配。2. **请求类型**和**请求的 URL**同时匹配成功，才会调用对应的处理函数。

### 模块化路由

1. 创建路由模块对应的 .js 文件。
2. 调用 `express.Router()` 函数创建路由对象。
3. 像路由对象上挂载具体的模块。
4. 使用 `module.exports` 向外共享路由对象
5. 使用 `app.use()` 函数注册路由模块。

`app.use()` 函数的作用，就是用来注册全局中间件。

```js
// router.js
// 这是路由模块
// 1. 导入 express
const express = require("express");
// 2. 创建路由对象
const router = express.Router();

// 3.挂载具体的路由
router.get("/user/list", (req, res) => {
  res.send("Get user list.");
});
router.post("/user/add", (req, res) => {
  res.send("Add New user.");
});
// 4. 向外导出路由对象
module.exports = router;

// 注册路由模块
// app.js
const express = require("express");
const app = express();

// 1. 导入路由模块
const router = require("./router.js");
// 2. 注册路由模块
// app.use(router);
app.use("/api", router); // 添加前缀 - api

app.listen("80", () => {
  console.log("服务已启动！");
});
```

## 3. 中间件

### 3.1 概念与格式

中间件（Middleware），特指业务流程的**中间处理环节**。

Express 中间件的调用流程。当一个请求到达 Express 的服务器之后，可以**连续调用多个**中间件，从而对这个请求进行**预处理**。

Express 中间件的格式。Express 的中间件，本质上就是一个 **`function` 处理函数**。

```js
var express = require('express')
var app = express()

app.get('/', (req, res, next) => {
  next();
})
```

注意：中间件函数的形参列表中，**必须包含 `next` 参数**。而路由处理函数中只包含 req 和 res。

`next()` 函数的作用。`next()` 函数是实现**多个中间件连续调用**的关键，它表示把流转关系**转交**给下一个**中间件或路由**。

### 3.2 全局生效的中间件

定义中间件函数

```js
// 常量 mw 所指向的，就是一个中间件函数
const mw = function (req, res, next) {
  console.log('这是一个最简单的中间件函数')
  // 注意：在当前中间件的业务处理完毕后，必须调用一个 next() 函数
  // 表示把流转关系转交给下一个中间件或路由
  next()
}
```

客户端发起的**任何请求**,到达服务器之后,**都会触发的中间件**,叫做全局生效的中间件.

通过 `app.use(中间件函数)`,即可定义一个**全局生效**的中间件.

```js
// 全局生效的中间件
app.use(mw)
```

简写:

```js
app.use((req, res, next) => {
  console.log('这是一个最简单的中间件函数');
  next();
})
```

作用:

多个中间件之间,**共享同一份 req 和 res** .基于这样的特性,我们可以在**上游**的中间件中,**统一**为 req 或 res 对象添加**自定义的属性或方法**,供**下游**的中间件或路由进行使用.

定义多个全局中间件.可以使用 app.use() 连续定义多个全局中间件.客户端请求到达服务器之后,按按照中间件义定义的先后顺序依次进行调用.

```js
// 定义多个全局中间件
// 定义第一个全局中间件
app.use((req, res, next) => {
  console.log('调用了第一个中间件')
  next()
})
// 定义第二个全局中间件
app.use((req, res, next) => {
  console.log('调用了第二个中间件')
  next()
})
// 定义第三个全局中间件
app.use((req, res, next) => {
  console.log('调用了第三个中间件')
  next()
})
// 请求这个路由,会依次触发上述三个全局中间件
app.get('/user', (req, res) => {
  res.send('User Page.')
})
```

### 3.3 局部生效的中间件

不使用 app.use() 定义的中间件,叫做局部生效的中间件.

```js
// 定义中间件函数 mw1
const mw1 = function (req, res, next) {
  console.log('这是一个最简单的中间件函数')
  next()
}
// mw1 这个中间件只在"当前路由中生效",这种用法属于"局部生效的中间件"
app.get("/", mw1, (req, res, next) => {
  res.send('Home Page.')
})
// mw1 这个中间件不会影响下面这个路由
app.get('/user', (req, res) => {
  res.send('User Page.')
})
```

定义多个局部中间件

```js
// 以下两种写法是"完全等价"的,可根据自己的喜好,选择任意一种方式进行使用
app.get('/', mw1, mw2, (req, res) => { res.send('Home Page.') })
app.get('/', [mw1, mw2], (req, res) => { res.send('Home Page.') })
```

### 3.4 中间件的5个注意事项

### 3.5 中间件的分类

### 3.6 自定义中间件
